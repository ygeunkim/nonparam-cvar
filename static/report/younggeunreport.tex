% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  pdftitle={Review on Nonparametric Estimation of Financial Risk},
  pdfauthor={Young-geun Kim2,1,},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[margin=1in]{geometry}
\usepackage{longtable,booktabs}
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{array}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{colortbl}
\usepackage{pdflscape}
\usepackage{tabu}
\usepackage{threeparttable}
\usepackage{threeparttablex}
\usepackage[normalem]{ulem}
\usepackage[normalem]{ulem}
\usepackage[utf8]{inputenc}
\usepackage{makecell}
\usepackage{xcolor}
\usepackage{hyperref}
\usepackage[boxruled, linesnumbered]{algorithm2e}
\IncMargin{1.5em}
\newcommand{\iid}{\stackrel{iid}{\sim}}
\newcommand{\indep}{\stackrel{indep}{\sim}}
\newcommand{\hsim}{\stackrel{H_0}{\sim}}
\newcommand{\ind}{\perp\!\!\!\perp}
\newcommand{\R}{\mathbb{R}}
\newcommand{\B}{\boldsymbol\beta}
\newcommand{\hb}{\boldsymbol{\hat\beta}}
\newcommand{\E}{\boldsymbol\epsilon}
\newcommand{\defn}{\mathpunct{:}=}
\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator*{\argmax}{argmax}
% https://github.com/rstudio/rmarkdown/issues/337
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

% https://github.com/rstudio/rmarkdown/pull/252
\usepackage{titling}
\setlength{\droptitle}{-2em}

\pretitle{\vspace{\droptitle}\centering\huge}
\posttitle{\par}

\preauthor{\centering\large\emph}
\postauthor{\par}

\predate{\centering\large\emph}
\postdate{\par}
\newlength{\cslhangindent}
\setlength{\cslhangindent}{1.5em}
\newenvironment{cslreferences}%
  {\setlength{\parindent}{0pt}%
  \everypar{\setlength{\hangindent}{\cslhangindent}}\ignorespaces}%
  {\par}

\title{Review on Nonparametric Estimation of Financial Risk}
\usepackage{etoolbox}
\makeatletter
\providecommand{\subtitle}[1]{% add subtitle to \maketitle
  \apptocmd{\@title}{\par {\large #1 \par}}{}{}
}
\makeatother
\subtitle{Nonparametric Estimation of Conditional VaR and Expected Shortfall}
\author{Young-geun Kim\textsuperscript{2,1,*}}
\date{19 Dec, 2019}

\usepackage{amsthm}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}{Lemma}[section]
\newtheorem{corollary}{Corollary}[section]
\newtheorem{proposition}{Proposition}[section]
\newtheorem{conjecture}{Conjecture}[section]
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\theoremstyle{definition}
\newtheorem{example}{Example}[section]
\theoremstyle{definition}
\newtheorem{exercise}{Exercise}[section]
\theoremstyle{remark}
\newtheorem*{remark}{Remark}
\newtheorem*{solution}{Solution}
\let\BeginKnitrBlock\begin \let\EndKnitrBlock\end
\begin{document}
\maketitle
\begin{abstract}
Value at Risk (VaR) is one of many risk measures for financial assets. Expected shortfall is the other one. I investigate nonparametric estimation methods concerning to these two. Especially, I consider conditional information such as exogenous variable or past observed returns. Thus, our problem becomes estimating the conditional VaR (CVaR) and conditional expected shortfall (CES). It is widely known that local linear fitting involves in linear smoother. In this local linear scheme, we replace the smoother with weighted nadaraya watson kernel. This will estimate the conditional probability densitiy. Given this estimator, we call the estimated CVaR and CES by weighted double kernel local linear estimator. It can also be shown that these estimators follow normal distribution asymptotically.
\end{abstract}

\textsuperscript{1} Sungkyunkwan University\\
\textsuperscript{2} Department of Statistics

\textsuperscript{*} Correspondence: \href{mailto:dudrms33@g.skku.edu}{Young-geun Kim \textless{}\href{mailto:dudrms33@g.skku.edu}{\nolinkurl{dudrms33@g.skku.edu}}\textgreater{}}

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

\hypertarget{concepts-of-financial-risk}{%
\subsection{Concepts of Financial Risk}\label{concepts-of-financial-risk}}

Consider any loss distribution. See Figure \ref{fig:lossdist}. This is the probability distribution of given time horizon. Value at risk (VaR) is the quantile for the right tail probability.

\begin{figure}[H]

{\centering \includegraphics[width=0.7\linewidth]{/Users/younggeun/Documents/GitHub/nonparam-cvar/static/report/younggeunreport_files/figure-latex/lossdist-1} 

}

\caption{Loss Distribution - Can the financial institution still be in business after a catastrophic event?}\label{fig:lossdist}
\end{figure}

Why do economists care about this kind of measures? Both financial institutions and regulatory commitee should analyze the risk of their interesting portfolio. Tsay (\protect\hyperlink{ref-Tsay:2010aa}{2010}) interprets this in the two viewpoint. For financial institutions, VaR can be read as maximal loss of a financial position during a given time period for a given probability. It leads to meaning the measre of loss under normal market conditions. For regulartory committe, on the other hand, it can be read as minimal loss under extraordinary market circumstances.

As we can see in the Figure \ref{fig:lossdist}, VaR is defined using the probability distribution of loss. Let \(p\) be the right tail probability, the red area in the figure. Let \(l\) be the time horizon, let \(L(l)\) be the loss function of the asset from \(t\) to \(t + l\), and let \(F_l\) be the cdf of \(L(l)\). Then

\begin{equation}
  p = P \left[ L(l) \ge VaR \right]
  \label{eq:vardef}
\end{equation}

\begin{figure}[H]

{\centering \includegraphics[width=0.7\linewidth]{/Users/younggeun/Documents/GitHub/nonparam-cvar/static/report/younggeunreport_files/figure-latex/lossquantile-1} 

}

\caption{CDF of Loss}\label{fig:lossquantile}
\end{figure}

See Figure \ref{fig:lossquantile}. VaR can be computed by finding the \(p\)-th quantile.

\begin{equation}
  VaR = \inf \left\{ x \mathpunct{:} F_l(x) \ge 1 - p \right\}
  \label{eq:varquant}
\end{equation}

\hypertarget{calculating-var}{%
\subsection{Calculating VaR}\label{calculating-var}}

There are many ways to get VaR in parametric way. Equation \eqref{eq:varquant} shows that VaR is the quantile in each time horizon. It is natural to employ quantile regression to get this quantile value.

This report consists of three parts. In Section \ref{background}, we covered basic concepts about CVaR and CES. In Section \ref{nonparam}, I reviewed the paper (Cai and Wang \protect\hyperlink{ref-cai:2008aa}{2008}) briefly. Theoretical parts were mostly skipped. In Section \ref{experiment}, we applied the method in both simulation setting and real data.

\hypertarget{background}{%
\section{Background}\label{background}}

\hypertarget{expected-shortfall}{%
\subsection{Expected Shortfall}\label{expected-shortfall}}

The reason why many authors only cover these two value-at-risk or expected shortfall that I will explain. Value at risk is famous and its concept is simple. In market, however, sometimes two portfolios can be merged. When this happens, the risk measure should not be greater than the sum of each. This is called subadditivity. VaR does not satistfy this property. It is possible for VaR to underestimate the actual loss. Expected loss is the one satisfying the condition. Expected shortfall is defined by the expected value of loss function if the VaR is exceeded.

\begin{equation}
  ES \mathpunct{:}=E \left[ L(l) \mid L(l) \ge VaR \right]
  \label{eq:esdef}
\end{equation}

\hypertarget{return}{%
\subsection{Return}\label{return}}

We prefer to use log return data. Let \(\{ P_t \}\) be the price series. Then the log return is defined by \(\{ Y_t \mathpunct{:}=\ln \frac{P_t}{P_{t - 1}} \}\). Loss occurs when the return \(\{ P_t - P_{t - 1} \}\) are negative, so we should use the negative returns or negative log returns.

Consider Taylor expansion for this log function. For any \(x_0 > 0\),

\begin{equation}
  \ln x \approx \ln x_0 + \frac{1}{x_0}(x - x_0)
\end{equation}

Write \(x = x_2\), \(x_0 = x_1\). Then

\begin{equation}
  \ln \frac{x_2}{x_1} \approx \frac{x_2}{x_1} - 1 = \frac{x_2 - x_1}{x_1}
  \label{eq:logpercent}
\end{equation}

Observe that the log return approximates to the change rate. Cai and Wang (\protect\hyperlink{ref-cai:2008aa}{2008}) used the following value in a real example part.

\[-100 Y_{t + 1} = -100 \ln \frac{P_{t + 1}}{P_t}\]

which approximates to percentage loss.

\hypertarget{conditional-information}{%
\subsection{Conditional Information}\label{conditional-information}}

In econometrics, conditional information are always researchers' interests. For example, we are interested in the exogenous variables like economic or market variables. When we look at return data, we can condition past observed returns.

Let \(\{ Y_t \}\) be stationary log returns and let \(\{ X_t \}\) be conditional information series.

\BeginKnitrBlock{definition}[Conditional Value-at-Risk]
\protect\hypertarget{def:condvar}{}{\label{def:condvar} \iffalse (Conditional Value-at-Risk) \fi{} }Let \(F(y \mid x)\) be the conditional cdf of \(Y_t\) given \(X_t = x\) and let \(S(y \mid x) \mathpunct{:}=1 - F(y \mid x)\). Then Conditional VaR is

\[\nu_p(x) \mathpunct{:}=S^{-1}(p \mid x)\]
\EndKnitrBlock{definition}

When formulating the conditional expected shortfall, we just add the term \(X_t = x\) in Equation \eqref{eq:esdef}. Let \(B \equiv \left\{ \omega \mathpunct{:} Y_t(\omega) \mid X_t = x \ge \nu_p(x) \right\} \in \mathcal{B}\). Then

\begin{equation}
  \begin{split}
    \mu_p(x) & = E \left[ Y_t \mid Y_t \ge \nu_p(x), X_t = x \right] \\
    & = \frac{1}{P(B)} \int_{B} Y_t dP \\
    & = \frac{1}{P\left( Y_t \ge \nu_p(x) \mid X_t = x \right)} \int_{\nu_p(x)}^\infty y f(y \mid x) dy \\
    & = \frac{1}{p} \int_{\nu_p(x)}^\infty y f(y \mid x) dy
  \end{split}
  \label{eq:cesformul}
\end{equation}

\hypertarget{nonparam}{%
\section{Nonparametric Estimation}\label{nonparam}}

The workflow of estimating is very simple. It uses the formulation of each CVaR and CES. Just put estimating notation in Equation \eqref{eq:cesformul}.

\begin{equation}
  \hat\mu_p(x) = \frac{1}{p} \int_{\hat\nu_p(x)}^\infty y \hat{f}(y \mid x) dy
  \label{eq:ceshat}
\end{equation}

Observe \(\hat\mu_p(x)\) and \(\hat{f}(y \mid x)\). After estimating these two, we will plugin the above integration and get the result. THen we can summarize the prcess as follows.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Estimate the conditional pdf \(\hat{f}(y \mid x)\).
\item
  Estimate the conditional cdf \(\hat{f}(y \mid x)\).
\item
  Invert the conditional cdf, and get \(\hat\nu_p(x)\).
\item
  Plug-in, and get \(\hat\mu_p(x)\).
\end{enumerate}

\hypertarget{double-kernel-local-linear}{%
\subsection{Double Kernel Local Linear}\label{double-kernel-local-linear}}

Consider any symmetric kernel \(K_h(\cdot)\). Then by Taylor expansion,

\begin{equation}
  \begin{split}
    E [ K_{h_0}(y - Y_t) \mid X_t = x ] & = K_{h_0} \ast f_{y \mid x} (y) \\
    & = f(y \mid x) + \frac{h_0^2}{2} \mu_2(K) f^{(2)}(y \mid x) + o(h_0^2)
  \end{split}
  \label{eq:convolution}
\end{equation}

where \(\mu_j(K) = \int_{\mathbb{R}}u^j K(u) du\). Thus, we now have a smoothing problem

\begin{equation}
  f(y \mid x) \approx E \left[ K_{h_0}(y - Y_t) \mid X_t = x \right]
  \label{eq:smoothing}
\end{equation}

Different with the other usual smoothing setting, the response becomes \(Y_t^{\ast}(y) \equiv K_{h_0}(y - Y_t)\). Given this, implement local linear least squares.

\begin{equation}
  \hat{f}(y \mid x) = \mathop{\mathrm{argmin}}_{\alpha(x), \beta(x)} \sum_{t = 1}^n W_h (x - X_t) \left[ Y_t^{\ast}(y) - \alpha(x) - \beta(x) (X_t - x) \right]^2
  \label{eq:doublell}
\end{equation}

This is called double local linear in that the problem involves in the two kernel, \(K_{h_0}\) and \(W_h\). Recall that the local linear estimate is equivalent to the weighted least squares. Let \(\mathbf{Y}_y^{\ast} = \left( Y_1(y), \ldots, Y_n(y) \right)^T \in \mathbb{R}^n\), let \(\mathbf{b}_x(x_t) \mathpunct{:}=(1, x_t - x)^T \in \mathbb{R}^2\), let \(\mathbf{b}_x(x) = \mathbf{e}_1 \mathpunct{:}=(1, 0)^T\), let \(X_x \mathpunct{:}=\left( \mathbf{b}_x(x_i)^T \right) \in \mathbb{R}^{n \times 2}\), and let \(W_x \mathpunct{:}=diag(W_h(x - X_j)) \in \mathbb{R}^{n \times n}\). Then the local linear solution is given by \(\hat{f}_{ll} = \hat\alpha\),

\begin{equation}
  \begin{split}
    \hat{f}_{ll}(y \mid x) & = \mathbf{e}_1^T (X_x^T W_x X_x)^{-1} X_x^T W_x \mathbf{Y}_y^{\ast} \\
    & = \mathbf{l}(x)^T \mathbf{Y}_y^{\ast} \\
    & \equiv \sum_{t = 1}^n l_t(x) Y_t^{\ast}(y)
  \end{split}
  \label{eq:llsolution}
\end{equation}

Cai and Wang (\protect\hyperlink{ref-cai:2008aa}{2008}) provides the exact form of each element by matrix calculation in the paper. This linear form of pdf easily gives its cdf. The conditional cdf can be calculated by

\begin{equation*}
  \begin{split}
    \hat{F}_{ll}(y \mid x) & = \int_\infty^y \hat{f}_{ll}(y \mid x) dy \\
    & = \sum_{t = 1}^n l_t(x) G_{h_0}(y - Y_t)
  \end{split}
\end{equation*}

where \(G(\cdot)\) is the cdf of \(K(\cdot)\). Since it is cdf, so it must be \(\hat{F}_{ll} \in [0, 1]\) and monotone increasing. Double local linear, however, does not guarantee these properties.

\hypertarget{weighted-nadaraya-watson}{%
\subsection{Weighted Nadaraya Watson}\label{weighted-nadaraya-watson}}

Since the above estimator cannot give desirable cdf to us, we consider another method, weighted nadaraya watson.

\hypertarget{weighted-double-kerenl-local-linear}{%
\subsection{Weighted Double Kerenl Local Linear}\label{weighted-double-kerenl-local-linear}}

\hypertarget{asymptotic-normality}{%
\subsection{Asymptotic Normality}\label{asymptotic-normality}}

\hypertarget{experiment}{%
\section{Experiments}\label{experiment}}

\hypertarget{simulation}{%
\subsection{Simulation}\label{simulation}}

\hypertarget{data-analysis}{%
\subsection{Data Analysis}\label{data-analysis}}

\hypertarget{conclusion}{%
\section{Conclusion}\label{conclusion}}

\hypertarget{discussion}{%
\subsection{Discussion}\label{discussion}}

\newpage

\hypertarget{references}{%
\section*{References}\label{references}}
\addcontentsline{toc}{section}{References}

\hypertarget{refs}{}
\begin{cslreferences}
\leavevmode\hypertarget{ref-cai:2008aa}{}%
Cai, Zongwu, and Xian Wang. 2008. ``Nonparametric estimation of conditional VaR and expected shortfall.'' \emph{Journal of Econometrics} 147 (1): 120--30. \url{https://doi.org/10.1016/j.jeconom.2008.09.005}.

\leavevmode\hypertarget{ref-Tsay:2010aa}{}%
Tsay, Ruey S. 2010. \emph{Analysis of Financial Time Series}. John Wiley \& Sons.
\end{cslreferences}

\end{document}
